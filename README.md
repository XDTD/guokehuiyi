# guokehuiyi
# canvas环境与配置

- 操作系统:ubuntu18

- CPU架构:x86

- 最小资源配置:8核16G

  

## 本地配置(development版本)

### 前置工作(选做)

改密码

```
sudo passwd root
```

换源

```
sudo vim /etc/apt/sources.list
```

替换成如下内容

```
deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse

```

更新

```
sudo apt update
```

安装git

```
sudo apt-get install git
```

### 开始配置

### postgresql

添加postgresql-12的源与安装

```
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'

wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc  --no-check-certificate | sudo apt-key add -

sudo apt-get update
sudo apt-get -y install postgresql-12
```

启动postgresql

```
sudo service postgresql start
```

```
sudo su postgres
psql -c "alter user postgres with password '19990923'"


```

退出数据库终端(ctrll+D)

创建与目前操作系统用户对应的数据库用户并赋权

```
sudo -u postgres createuser $USER
sudo -u postgres psql -c "alter user $USER with superuser" postgres 
```

进入postsql改密码

```
sudo -u postgres psql
ALTER USER td WITH PASSWORD '19990923';
\du
```

退出数据库终端(ctrll+D)



创建数据库

```
createuser canvas --no-createdb --no-superuser --no-createrole --pwprompt
createdb canvas --owner=canvas
```











### 下载代码

```
mkdir ~/workspace; cd ~/workspace
git clone https://github.com/instructure/canvas-lms.git canvas
cd canvas
git checkout stable
git fetch
```



### 相关依赖安装

```
sudo apt-get update
sudo apt-get -y install postgresql-12 zlib1g-dev libxml2-dev libsqlite3-dev libpq-dev libxmlsec1-dev curl build-essential
```

### ruby(apt安装方式)

```
sudo apt update
sudo apt -y install software-properties-common
sudo apt-add-repository ppa:brightbox/ruby-ng
sudo apt -y install ruby2.7  ruby2.7-dev
```

### java安装

[如何在 Ubuntu 20.04 上安装 Java - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/137114682)

```
sudo apt update
sudo apt install -y openjdk-8-jdk 
java -version
sudo update-alternatives --config java
sudo vim /etc/environment
```

```
JAVA_HOME="/usr/lib/jvm/java-8-openjdk-amd64"
```

```text
source /etc/environment
```

### bundle

```
sudo gem install bundle
sudo gem install bundler -v 2.2.24
sudo gem install nokogumbo scrypt sanitize
bundle _2.2.24_ install --without pulsar
```



### yarn安装

```
curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -

echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
sudo apt update && sudo apt install yarn
```

### nodejs 14

```
sudo apt remove nodejs*
sudo apt autoremove
curl -sL https://deb.nodesource.com/setup_14.x | sudo -E bash -
sudo apt-get install -y nodejs
```

yarn源

```
npm config set registry https://registry.npm.taobao.org/
```

继续安装

```
yarn install --pure-lockfile
```

### 配置文件

```
for config in amazon_s3 delayed_jobs domain file_store outgoing_mail security external_migration dynamic_settings database; \
          do cp -v config/$config.yml.example config/$config.yml; done
```

这一步删了`--without pulsar`，不知道影响大不大

```
export PGHOST=localhost
/usr/lib/postgresql/12/bin/initdb ~/postgresql-data/ -E utf8
```

改配置文件

```
cd ~/workspace/canvas
cp config/dynamic_settings.yml.example config/dynamic_settings.yml
cp config/database.yml.example config/database.yml
sudo vim  config/database.yml
```

将里边数据的name和用户密码更改，现在如果只是本地测试只用改test和development的，数据库都改成canvas，后续如果要发布需要额外建立s数据库对应production的



继续配置

```
sudo chown -R td config/environment.rb log tmp public/assets \
                              app/stylesheets/_brandable_variables_defaults_autogenerated.scss \
                              app/stylesheets/brandable_css_brands Gemfile.lock config.ru
```

### canvas数据库初始化

```
bundle exec rails db:initial_setup
```

会要求输入管理员的邮箱，密码和机构名称，后续依靠这一步输入的邮箱和密码登录canvas，**注意：在刚开始这个账户是登录canvas的唯一用户(相当于root)**，依靠这个用户登录后开放注册或者导入账号才能有其他账号

```
test@qq.com
19990923
test
```

**canvas初始化**

```
bundle exec rails canvas:compile_assets
```

### 防火墙

云服务器需要在云服务器商配置安全组规则，增加端口3000的tcp入规则，如果服务器上本身还安装了防火墙ufw，还需要在ufw上增加规则

```
sudo ufw allow 3000/tcp
sudo ufw reload
```



### 启动canvas

如果是本地直接运行如下命令，然后打开localhost:3000即可

```
bundle exec rails server
```

如果是在服务器上执行如下命令，然后打开ip:3000。

```
 bundle exec rails s -b 0.0.0.0 -p 3000
```



在浏览器访问http://127.0.0.1:3000/,账号密码即上面输入的邮箱和密码







### 重启canvas

development版本在后台运行的时候可能会因为资源配置太低等原因卡死，这个时候需要重启，执行如下命令即可，注意下面的目录/home/td/workspace/guokehuiyi/canvas/需要更改为canvas的安装目录

```
cat /home/td/workspace/guokehuiyi/canvas/tmp/pids/server.pid
kill -9  pid
bundle exec rails s -b 0.0.0.0 -p 3000
```


