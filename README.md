# guokehuiyi

# canvas环境与配置

- 操作系统:ubuntu18

- CPU架构:x86

- 最小资源配置:8核16G

  

## 本地配置(development版本)

### 前置工作(选做)

改密码

```
sudo passwd root
```

换源

```
sudo vim /etc/apt/sources.list
```

替换成如下内容

```
deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse

```

更新

```
sudo apt update
```

安装git

```
sudo apt-get install git
```

### 开始配置

### postgresql

添加postgresql-12的源与安装

```
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'

wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc  --no-check-certificate | sudo apt-key add -

sudo apt-get update
sudo apt-get -y install postgresql-12
```

启动postgresql

```
sudo service postgresql start
```

```
sudo su postgres
psql -c "alter user postgres with password '19990923'"


```

退出数据库终端(ctrll+D)

创建与目前操作系统用户对应的数据库用户并赋权

```
sudo -u postgres createuser $USER
sudo -u postgres psql -c "alter user $USER with superuser" postgres 
```

进入postsql改密码

```
sudo -u postgres psql
ALTER USER td WITH PASSWORD '19990923';
\du
```

退出数据库终端(ctrll+D)



创建数据库

```
createuser canvas --no-createdb --no-superuser --no-createrole --pwprompt
createdb canvas --owner=canvas
```











### 下载代码

```
mkdir ~/workspace; cd ~/workspace
git clone https://github.com/instructure/canvas-lms.git canvas
cd canvas
git checkout stable
git fetch
```



### 相关依赖安装

```
sudo apt-get update
sudo apt-get -y install postgresql-12 zlib1g-dev libxml2-dev libsqlite3-dev libpq-dev libxmlsec1-dev curl build-essential
```

### ruby(apt安装方式)

```
sudo apt update
sudo apt -y install software-properties-common
sudo apt-add-repository ppa:brightbox/ruby-ng
sudo apt -y install ruby2.7  ruby2.7-dev
```

### java安装

[如何在 Ubuntu 20.04 上安装 Java - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/137114682)

```
sudo apt update
sudo apt install -y openjdk-8-jdk 
java -version
sudo update-alternatives --config java
sudo vim /etc/environment
```

```
JAVA_HOME="/usr/lib/jvm/java-8-openjdk-amd64"
```

```text
source /etc/environment
```

### bundle

```
sudo gem install bundle
sudo gem install bundler -v 2.2.24
sudo gem install nokogumbo scrypt sanitize
bundle _2.2.24_ install --without pulsar
```



### yarn安装

```
curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -

echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
sudo apt update && sudo apt install yarn
```

### nodejs 14

```
sudo apt remove nodejs*
sudo apt autoremove
curl -sL https://deb.nodesource.com/setup_14.x | sudo -E bash -
sudo apt-get install -y nodejs
```

yarn源

```
npm config set registry https://registry.npm.taobao.org/
```

继续安装

```
yarn install --pure-lockfile
```

### 配置文件

```
for config in amazon_s3 delayed_jobs domain file_store outgoing_mail security external_migration dynamic_settings database; \
          do cp -v config/$config.yml.example config/$config.yml; done
```

这一步删了`--without pulsar`，不知道影响大不大

```
export PGHOST=localhost
/usr/lib/postgresql/12/bin/initdb ~/postgresql-data/ -E utf8
```

改配置文件

```
cd ~/workspace/canvas
cp config/dynamic_settings.yml.example config/dynamic_settings.yml
cp config/database.yml.example config/database.yml
sudo vim  config/database.yml
```

将里边数据的name和用户密码更改，现在如果只是本地测试只用改test和development的，数据库都改成canvas，后续如果要发布需要额外建立s数据库对应production的



继续配置

```
sudo chown -R td config/environment.rb log tmp public/assets \
                              app/stylesheets/_brandable_variables_defaults_autogenerated.scss \
                              app/stylesheets/brandable_css_brands Gemfile.lock config.ru
```

### canvas数据库初始化

```
bundle exec rails db:initial_setup
```

会要求输入管理员的邮箱，密码和机构名称，后续依靠这一步输入的邮箱和密码登录canvas，**注意：在刚开始这个账户是登录canvas的唯一用户(相当于root)**，依靠这个用户登录后开放注册或者导入账号才能有其他账号

```
test@qq.com
19990923
test
```

**canvas初始化**

```
bundle exec rails canvas:compile_assets
```

### 防火墙

云服务器需要在云服务器商配置安全组规则，增加端口3000的tcp入规则，如果服务器上本身还安装了防火墙ufw，还需要在ufw上增加规则

```
sudo ufw allow 3000/tcp
sudo ufw reload
```



### 启动canvas

如果是本地直接运行如下命令，然后打开localhost:3000即可

```
bundle exec rails server
```

如果是在服务器上执行如下命令，然后打开ip:3000。

```
 bundle exec rails s -b 0.0.0.0 -p 3000
```



在浏览器访问http://127.0.0.1:3000/,账号密码即上面输入的邮箱和密码







### 重启canvas

development版本在后台运行的时候可能会因为资源配置太低等原因卡死，这个时候需要重启，执行如下命令即可，注意下面的目录/home/td/workspace/guokehuiyi/canvas/需要更改为canvas的安装目录

```
cat /home/td/workspace/guokehuiyi/canvas/tmp/pids/server.pid
kill -9  pid
bundle exec rails s -b 0.0.0.0 -p 3000
```

# BBB与Canvas集成--BBB部署及配置文档

*本文档记录及提供bbb服务器配置注意事项及部分问题解决方案，更多的问题解决方案建议参考项目开源社区。*

## 安装前检查

1. 服务器80、443端口空闲
2. 用于配置SSL证书的解析到公网IP的域名。
3. 服务器语言环境配置为"en_US.UTF-8"

## BBB部署

提供部署脚本"bbb-install.sh"
`
wget -qO- https://ubuntu.bigbluebutton.org/bbb-install.sh | bash -s -- -w -a -v bionic-23 -s bbb.example.com -e info@example.com
`
此命令拉取最新版本的`bbb-install.sh`，将其发送到 Bash shell 解释器，并使用提供的参数安装 BigBlueButton。其中:

- `-w` 安装简单防火墙 (UFW) 以限制对 TCP/IP 端口 22、80 和 443 以及范围 16384-32768 内的 UDP 端口的访问，
- `-a` 安装 API 演示（可以轻松地在服务器上进行一些快速测试），
- `-v bionic-23` 安装最新版本的 BigBlueButton 2.3.x，
- `-s`将服务器的主机名设置为bbb.example.com，并且
- `-e` 为 Let's Encrypt 提供一个电子邮件地址，以便为主机生成有效的 SSL 证书。

- (建议安装API演示，以检验各部分功能是否正常)
- (执行`wget`命令部署BBB时，需要将`bbb.example.com`和`info@example.com`更改为自己的域名和邮箱，尤其是域名需要解析到服务器公网IP)
- 检验BBB部署后，可以使用`sudo apt-get purge bbb-demo`卸载API演示

## BBB开发

1. Git 环境配置   

- 克隆一个仓库
- 创建一个分支
- 将更改推送回存储库
- (检查开源项目版本)

2. 开发环境配置

- 安装核心开发工具(java JDK)
  - `sudo apt-get install git-core ant ant-contrib openjdk-8-jdk-headless`
- 设置 JAVA_HOME变量
  - `sudo vi ~/.profile`
  - `export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64`(在文件末尾添加)
  - 重新加载配置文件`source ~/.profile`
- 安装开发工具
  - `curl -s "https://get.sdkman.io" | bash`
  - 
  - `source "$HOME/.sdkman/bin/sdkman-init.sh"`

  - `sdk install gradle 5.5.1`
  - `sdk install grails 3.3.9`
  - `sdk install sbt 1.2.8`
  - `sdk install maven 3.5.0`
    (注意：开发测试前，将`/usr/share/bbb-web/WEB-INF/classes/application.yml`文件中的`secure: false`设置为`false`)

3. HTML5客户端开发

   BigBlueButton 中的 HTML5 客户端是使用框架Meteor构建的。需要安装下列组件。

- 安装 `Meteor.js`
  - `curl https://install.meteor.com/ | sh`
- 打开文件位置`bigbluebutton-html5/`并设置适当的 Meteor 版本(需要在相应目录执行，不然后面会报错！！！)
  - `meteor update --allow-superuser --release 1.10.2`
- NginX 重定向到 Meteor
  - 更改`/etc/bigbluebutton/nginx/bbb-html5.nginx`使用4100端口用于开发测试。
- 更改设置以使得摄像头和屏幕共享正常使用
  - `grep "wsUrl" /usr/share/meteor/bundle/programs/server/assets/app/config/settings.yml`(记录得到的数据内容)
  - 将`/private/config/settings.yml`中的`wsUrl`值改为上一步中的值。
- 修改代码及配置
- 打包开发版本的 HTML5 客户端
  - `sudo systemctl stop bbb-html5`先暂停生产版本的HTML5客户端
  - 安装 npm 依赖
    - `meteor npm install`
  - 运行开发板程序
    - `npm start`
  - 注意：通过“npm start”启动开发HTML5客户端后，若在麦克风回声测试过程中可能会看到错误“呼叫超时（错误1006）”，需要将`bigbluebutton-html5/private/config/settings.yml`中的`sipjsHackViaWs`配置为`true`
  - 运行部署脚本`bigbluebutton-html5/deploy_to_usr_share.sh`,本地部署BBB HTML5。(需要将上面步骤中的nginx端口修改回`poolhtml5servers`)
- 生产版部署：
  - `meteor build --server-only ~/dev/bigbluebutton/bigbluebutton-html5/meteorbundle`
  - Meteor 会将开发版本构建为一个`.tar.gz`文件，因此我们需要将其解压缩并将其放置在正确的目录中bbb-html5以供使用。
  - `sudo tar -xzvf ~/dev/bigbluebutton/bigbluebutton-html5/meteorbundle/*.tar.gz -C /usr/share/meteor`
  - 开启HTML5服务`sudo systemctl start bbb-html5`

4. BBB-Web 开发

- BigBlueButton 的一些组件需要 bbb-common-message。所以需要先构建这个。否则，您将遇到编译错误。
  - 在`~/dev/bigbluebutton/bbb-common-message`路径下运行`./deploy.sh`
- 在`~/dev/bigbluebutton/bigbluebutton-web/grails-app/conf/bigbluebutton.properties`文件中修改BBB服务器的地址和密钥。(查看方法：`sudo bbb-conf --secret`)
- 授权用户上传文稿及写入日志
  - `sudo chmod -R ugo+rwx /var/bigbluebutton`
  - `sudo chmod -R ugo+rwx /var/log/bigbluebutton`
- 创建文件`-p ~/.sbt/1.0`,并写入
  - `resolvers += "Artima Maven Repository" at "https://repo.artima.com/releases"`
  - `updateOptions := updateOptions.value.withCachedResolution(true)`
- 在`~/dev/bigbluebutton/bigbluebutton-web/`中构建BBB Web
  - 下载依赖库`./build.sh`
  - 启动 grails 并告诉侦听端口 8090 `./run.sh`
- run bbb-web 时会提示必须是bbb user才可以（解决：将run.sh中的判断语句改为自己的用户名）

5. BBB Web部署

- 将所有项目编译到一个单一的 war 
  - `grails assemble`
- 创建新目录并打开
  - `mkdir exploded && cd exploded`
- 解压新建目录下的war内容
  - `jar -xvf ../build/libs/bigbluebutton-0.10.0.war`
- 检查所有jar依赖项都列出后复制.`cp ../run-prod.sh .`
- 为当前的生产版本复制一份。
  - `sudo cp -R /usr/share/bbb-web /usr/share/bbb-web-old`
- 删除所有我们需要复制用于生产的文件
  - `sudo rm -rf /usr/share/bbb-web/assets/ /usr/share/bbb-web/META-INF/ /usr/share/bbb-web/org/ /usr/share/bbb-web/run-prod.sh  /usr/share/bbb-web/WEB-INF/`
- 将编译好的文件复制到生产目录中
  - `sudo cp -R . /usr/share/bbb-web/`
- 配置权限
  - `sudo chown bigbluebutton:bigbluebutton /usr/share/bbb-web`
  - `sudo chown -R bigbluebutton:bigbluebutton /usr/share/bbb-web/assets/ /usr/share/bbb-web/META-INF/ /usr/share/bbb-web/org/ /usr/share/bbb-web/run-prod.sh /usr/share/bbb-web/WEB-INF/`
- 运行BBB Web服务
  - `sudo service bbb-web start`





# 脚本相关参数

pdfListen.sh需要填入postgresql的密码，地址，端口，用户等参数

```
result=`psql "host=127.0.0.1 port=5432 user=canvas  password=yourpassword dbname=canvas" << EOF
select url from url_to_livego order by course_id;
\q
EOF `
```

以及果壳会议的路径

```
# path
guokehuiyiPath="your guokehuiyi path"
```

verify.sh中也需要上述参数

```
psql "host=127.0.0.1 port=5432 user=canvas  password=yourpassword dbname=canvas" << EOF

```

```
# path
guokehuiyiPath="your guokehuiyi path"
```

