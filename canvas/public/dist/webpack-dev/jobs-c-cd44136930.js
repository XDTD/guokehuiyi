(window["canvasWebpackJsonp"] = window["canvasWebpackJsonp"] || []).push([["jobs"],{

/***/ "EcEK":
/*!***********************************!*\
  !*** ./ui/features/jobs/index.js ***!
  \***********************************/
/*! no exports provided */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _jquery_index__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./jquery/index */ \"xk2Z\");\n/*\n * Copyright (C) 2011 - present Instructure, Inc.\n *\n * This file is part of Canvas.\n *\n * Canvas is free software: you can redistribute it and/or modify it under\n * the terms of the GNU Affero General Public License as published by the Free\n * Software Foundation, version 3 of the License.\n *\n * Canvas is distributed in the hope that it will be useful, but WITHOUT ANY\n * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR\n * A PARTICULAR PURPOSE. See the GNU Affero General Public License for more\n * details.\n *\n * You should have received a copy of the GNU Affero General Public License along\n * with this program. If not, see <http://www.gnu.org/licenses/>.\n */\n // TODO: get this stuff off window, need to move the domready stuff out of\n// jobs.coffee into here\n\nwindow.jobs = new _jquery_index__WEBPACK_IMPORTED_MODULE_0__[\"default\"].Jobs(ENV.JOBS.opts).init();\nwindow.running = new _jquery_index__WEBPACK_IMPORTED_MODULE_0__[\"default\"].Workers(ENV.JOBS.running_opts).init();\nwindow.tags = new _jquery_index__WEBPACK_IMPORTED_MODULE_0__[\"default\"].Tags(ENV.JOBS.tags_opts).init();\n\n//# sourceURL=webpack:///./ui/features/jobs/index.js?");

/***/ }),

/***/ "hDVN":
/*!*********************************************************************!*\
  !*** ./frontend_build/i18n.js?jobs!./ui/shims/dummyI18nResource.js ***!
  \*********************************************************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _canvas_i18n_i18nObj__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @canvas/i18n/i18nObj */ \"HGxv\");\n/* harmony import */ var translations_core_en__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! translations/_core_en */ \"0sPK\");\n\n    \n    \n    \n\n    /* harmony default export */ __webpack_exports__[\"default\"] = (_canvas_i18n_i18nObj__WEBPACK_IMPORTED_MODULE_0__[\"default\"].scoped('jobs'));\n  \n\n//# sourceURL=webpack:///./ui/shims/dummyI18nResource.js?./frontend_build/i18n.js?jobs");

/***/ }),

/***/ "xk2Z":
/*!******************************************!*\
  !*** ./ui/features/jobs/jquery/index.js ***!
  \******************************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var i18n_jobs__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! i18n!jobs */ \"hDVN\");\n/* harmony import */ var jquery__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! jquery */ \"ouhR\");\n/* harmony import */ var jquery__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(jquery__WEBPACK_IMPORTED_MODULE_1__);\n/* harmony import */ var slickgrid__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! slickgrid */ \"sbFY\");\n/* harmony import */ var _canvas_jquery_jquery_ajaxJSON__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! @canvas/jquery/jquery.ajaxJSON */ \"dhbk\");\n/* harmony import */ var jqueryui_dialog__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! jqueryui/dialog */ \"ESjL\");\n//\n// Copyright (C) 2011 - present Instructure, Inc.\n//\n// This file is part of Canvas.\n//\n// Canvas is free software: you can redistribute it and/or modify it under\n// the terms of the GNU Affero General Public License as published by the Free\n// Software Foundation, version 3 of the License.\n//\n// Canvas is distributed in the hope that it will be useful, but WITHOUT ANY\n// WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR\n// A PARTICULAR PURPOSE. See the GNU Affero General Public License for more\n// details.\n//\n// You should have received a copy of the GNU Affero General Public License along\n// with this program. If not, see <http://www.gnu.org/licenses/>.\n\n\n\n\n\n/*\nxsslint safeString.identifier klass d out_of runtime_string\n*/\n\nfunction fillin_job_data(job) {\n  jquery__WEBPACK_IMPORTED_MODULE_1___default()('#show-job .show-field').each((idx, field) => {\n    const field_name = field.id.replace('job-', '');\n    jquery__WEBPACK_IMPORTED_MODULE_1___default()(field).text(job[field_name] || '');\n  });\n  jquery__WEBPACK_IMPORTED_MODULE_1___default()('#job-id-link').attr('href', `/jobs?flavor=id&q=${job.id}`);\n}\n\nlet selected_job = null;\n\nclass FlavorGrid {\n  constructor(options, type_name, grid_name) {\n    this.setTimer = () => {\n      return setTimeout(() => this.refresh(this.setTimer), this.options.refresh_rate);\n    };\n\n    this.saveSelection = () => {\n      if (this.type_name === 'running') {\n        this.oldSelected = {};\n        return this.grid.getSelectedRows().map(row => this.oldSelected[this.data[row].id] = true);\n      }\n    };\n\n    this.restoreSelection = () => {\n      if (this.type_name === 'running') {\n        let index = 0;\n        const newSelected = [];\n\n        for (const item of this.data) {\n          if (this.oldSelected[item.id]) {\n            newSelected.push(index);\n          }\n\n          index += 1;\n        }\n\n        this.restoringSelection = true;\n        this.grid.setSelectedRows(newSelected);\n        return this.restoringSelection = false;\n      }\n    };\n\n    this.refresh = cb => {\n      return this.$element.queue(() => jquery__WEBPACK_IMPORTED_MODULE_1___default.a.ajaxJSON(this.options.url, 'GET', {\n        flavor: this.options.flavor,\n        q: this.query\n      }, data => {\n        this.saveSelection();\n        this.data.length = 0;\n        this.loading = {};\n\n        for (const item of data[this.type_name]) {\n          this.data.push(item);\n        }\n\n        if (data.total && data.total > this.data.length) {\n          for (let i = this.data.length, end = data.total, asc = this.data.length <= end; asc ? i < end : i > end; asc ? i++ : i--) {\n            this.data.push({});\n          }\n        }\n\n        if (this.sortData) {\n          this.sort(null, this.sortData);\n        } else {\n          this.grid.invalidate();\n          this.restoreSelection();\n        }\n\n        if (typeof cb === 'function') {\n          cb();\n        }\n\n        if (typeof this.updated === 'function') {\n          this.updated();\n        }\n\n        return this.$element.dequeue();\n      }));\n    };\n\n    this.options = options;\n    this.type_name = type_name;\n    this.grid_name = grid_name;\n    this.data = [];\n    this.$element = jquery__WEBPACK_IMPORTED_MODULE_1___default()(this.grid_name);\n    setTimeout(this.refresh, 0);\n\n    if (this.options.refresh_rate) {\n      this.setTimer();\n    }\n\n    this.query = '';\n  }\n\n  change_flavor(flavor) {\n    this.options.flavor = flavor;\n    this.grid.setSelectedRows([]);\n    return this.refresh();\n  }\n\n  grid_options() {\n    return {\n      rowHeight: 20\n    };\n  }\n\n  init() {\n    this.columns = this.build_columns();\n    this.loading = {};\n    this.grid = new slickgrid__WEBPACK_IMPORTED_MODULE_2__[\"default\"].Grid(this.grid_name, this.data, this.columns, this.grid_options());\n    return this;\n  }\n\n}\n\nwindow.Jobs = class Jobs extends FlavorGrid {\n  constructor(options, type_name = 'jobs', grid_name = '#jobs-grid') {\n    if (options.max_attempts) {\n      Jobs.max_attempts = options.max_attempts;\n    }\n\n    super(options, type_name, grid_name);\n\n    if (options.starting_query) {\n      this.query = options.starting_query;\n    }\n\n    this.show_search(jquery__WEBPACK_IMPORTED_MODULE_1___default()('#jobs-flavor').val());\n  }\n\n  search(query) {\n    this.query = query;\n    return this.refresh();\n  }\n\n  show_search(flavor) {\n    switch (flavor) {\n      case 'id':\n      case 'strand':\n      case 'tag':\n        jquery__WEBPACK_IMPORTED_MODULE_1___default()('#jobs-search').show();\n        jquery__WEBPACK_IMPORTED_MODULE_1___default()('#jobs-search').attr('placeholder', flavor);\n\n      default:\n        jquery__WEBPACK_IMPORTED_MODULE_1___default()('#jobs-search').hide();\n    }\n  }\n\n  change_flavor(flavor) {\n    this.show_search(flavor);\n    return super.change_flavor(flavor);\n  }\n\n  attempts_formatter(r, c, d) {\n    let klass;\n\n    if (!this.data[r].id) {\n      return '';\n    }\n\n    const max = this.data[r].max_attempts || Jobs.max_attempts;\n\n    if (d === 0) {\n      klass = '';\n    } else if (d < max) {\n      klass = 'has-failed-attempts';\n    } else if (d === this.options.on_hold_attempt_count) {\n      klass = 'on-hold';\n      d = 'hold';\n    } else {\n      klass = 'has-failed-max-attempts';\n    }\n\n    const out_of = d === 'hold' ? '' : `/ ${max}`;\n    return `<span class='${klass}'>${d}${out_of}</span>`;\n  }\n\n  load(row) {\n    return this.$element.queue(() => {\n      row -= row % this.options.limit;\n\n      if (this.loading[row]) {\n        this.$element.dequeue();\n        return;\n      }\n\n      this.loading[row] = true;\n      return jquery__WEBPACK_IMPORTED_MODULE_1___default.a.ajaxJSON(this.options.url, 'GET', {\n        flavor: this.options.flavor,\n        q: this.query,\n        offset: row\n      }, data => {\n        this.data.splice(row, row + data[this.type_name].length - row, ...[].concat(data[this.type_name]));\n        this.grid.invalidate();\n        return this.$element.dequeue();\n      });\n    });\n  }\n\n  id_formatter(r, c, d) {\n    if (this.data[r].id) {\n      return this.data[r].id;\n    } else {\n      this.load(r);\n      return \"<span class='unloaded-id'>-</span>\";\n    }\n  }\n\n  build_columns() {\n    return [{\n      id: 'id',\n      name: i18n_jobs__WEBPACK_IMPORTED_MODULE_0__[\"default\"].t('columns.id', 'id'),\n      field: 'id',\n      width: 100,\n      formatter: this.id_formatter.bind(this)\n    }, {\n      id: 'tag',\n      name: i18n_jobs__WEBPACK_IMPORTED_MODULE_0__[\"default\"].t('columns.tag', 'tag'),\n      field: 'tag',\n      width: 200\n    }, {\n      id: 'attempts',\n      name: i18n_jobs__WEBPACK_IMPORTED_MODULE_0__[\"default\"].t('columns.attempt', 'attempt'),\n      field: 'attempts',\n      width: 65,\n      formatter: this.attempts_formatter.bind(this)\n    }, {\n      id: 'priority',\n      name: i18n_jobs__WEBPACK_IMPORTED_MODULE_0__[\"default\"].t('columns.priority', 'priority'),\n      field: 'priority',\n      width: 60\n    }, {\n      id: 'strand',\n      name: i18n_jobs__WEBPACK_IMPORTED_MODULE_0__[\"default\"].t('columns.strand', 'strand'),\n      field: 'strand',\n      width: 100\n    }, {\n      id: 'singleton',\n      name: i18n_jobs__WEBPACK_IMPORTED_MODULE_0__[\"default\"].t('columns.singleton', 'singleton'),\n      field: 'singleton',\n      width: 100\n    }, {\n      id: 'run_at',\n      name: i18n_jobs__WEBPACK_IMPORTED_MODULE_0__[\"default\"].t('columns.run_at', 'run at'),\n      field: 'run_at',\n      width: 165\n    }];\n  }\n\n  init() {\n    super.init();\n    this.grid.setSelectionModel(new slickgrid__WEBPACK_IMPORTED_MODULE_2__[\"default\"].RowSelectionModel());\n    this.grid.onSelectedRowsChanged.subscribe(() => {\n      if (this.restoringSelection) return;\n      const rows = this.grid.getSelectedRows();\n      const row = (rows != null ? rows.length : void 0) === 1 ? rows[0] : -1;\n      selected_job = this.data[rows[0]] || {};\n      return fillin_job_data(selected_job);\n    });\n    return this;\n  }\n\n  selectAll() {\n    this.grid.setSelectedRows(__range__(0, this.data.length, false));\n    return this.grid.onSelectedRowsChanged.notify();\n  }\n\n  onSelected(action) {\n    const params = {\n      flavor: this.options.flavor,\n      q: this.query,\n      update_action: action\n    };\n\n    if (this.grid.getSelectedRows().length < 1) {\n      alert('No jobs are selected');\n      return;\n    }\n\n    const all_jobs = this.grid.getSelectedRows().length > 1 && this.grid.getSelectedRows().length === this.data.length;\n\n    if (all_jobs) {\n      const message = (() => {\n        switch (action) {\n          case 'hold':\n            return i18n_jobs__WEBPACK_IMPORTED_MODULE_0__[\"default\"].t('confirm.hold_all', 'Are you sure you want to hold *all* jobs of this type and matching this query?');\n\n          case 'unhold':\n            return i18n_jobs__WEBPACK_IMPORTED_MODULE_0__[\"default\"].t('confirm.unhold_all', 'Are you sure you want to unhold *all* jobs of this type and matching this query?');\n\n          case 'destroy':\n            return i18n_jobs__WEBPACK_IMPORTED_MODULE_0__[\"default\"].t('confirm.destroy_all', 'Are you sure you want to destroy *all* jobs of this type and matching this query?');\n        }\n      })();\n\n      if (!confirm(message)) return;\n    } // special case -- if they've selected all, then don't send the ids so that\n    // we can operate on jobs that match the query but haven't even been loaded\n    // yet\n\n\n    if (!all_jobs) {\n      params.job_ids = this.grid.getSelectedRows().map(row => this.data[row].id);\n    }\n\n    jquery__WEBPACK_IMPORTED_MODULE_1___default.a.ajaxJSON(this.options.batch_update_url, 'POST', params, this.refresh);\n    return this.grid.setSelectedRows([]);\n  }\n\n  updated() {\n    jquery__WEBPACK_IMPORTED_MODULE_1___default()('#jobs-total').text(this.data.length);\n\n    if (this.data.length === 1 && this.type_name === 'jobs') {\n      this.grid.setSelectedRows([0]);\n      return this.grid.onSelectedRowsChanged.notify();\n    }\n  }\n\n  getFullJobDetails(cb) {\n    if (!selected_job || selected_job.handler) {\n      return cb();\n    } else {\n      return jquery__WEBPACK_IMPORTED_MODULE_1___default.a.ajaxJSON(`${this.options.job_url}/${selected_job.id}`, 'GET', {\n        flavor: this.options.flavor\n      }, data => {\n        selected_job.handler = data.handler;\n        selected_job.last_error = data.last_error;\n        fillin_job_data(selected_job);\n        return cb();\n      });\n    }\n  }\n\n};\n\nclass Workers extends Jobs {\n  constructor(options) {\n    super(options, 'running', '#running-grid');\n  }\n\n  runtime_formatter(r, c, d) {\n    let klass;\n    const runtime = (new Date() - Date.parse(d)) / 1000;\n\n    if (runtime >= this.options.super_slow_threshold) {\n      klass = 'super-slow';\n    } else if (runtime > this.options.slow_threshold) {\n      klass = 'slow';\n    } else {\n      klass = '';\n    }\n\n    let format = 'HH:mm:ss';\n\n    if (runtime > 86400) {\n      format = 'd\\\\dHH:mm:ss';\n    }\n\n    let runtime_string = new Date(null, null, null, null, null, runtime).toString(format);\n\n    if (runtime > 86400 * 28) {\n      runtime_string = 'FOREVA';\n    }\n\n    return `<span class='${klass}'>${runtime_string}</span>`;\n  }\n\n  build_columns() {\n    const cols = [{\n      id: 'worker',\n      name: i18n_jobs__WEBPACK_IMPORTED_MODULE_0__[\"default\"].t('columns.worker', 'worker'),\n      field: 'locked_by',\n      width: 90\n    }].concat(super.build_columns());\n    cols.pop();\n    cols.push({\n      id: 'runtime',\n      name: i18n_jobs__WEBPACK_IMPORTED_MODULE_0__[\"default\"].t('columns.runtime', 'runtime'),\n      field: 'locked_at',\n      width: 85,\n      formatter: this.runtime_formatter.bind(this)\n    });\n\n    for (const col of cols) {\n      col.sortable = true;\n    }\n\n    return cols;\n  }\n\n  updated() {}\n\n  init() {\n    super.init();\n\n    this.sort = (event, data) => {\n      this.sortData = data;\n\n      if (event) {\n        this.saveSelection();\n      }\n\n      const field = data.sortCol.field;\n      this.data.sort((a, b) => {\n        let result;\n        const aField = a[field] || '';\n        const bField = b[field] || '';\n\n        if (aField > bField) {\n          result = 1;\n        } else if (aField < bField) {\n          result = -1;\n        } else {\n          result = 0;\n        }\n\n        if (!data.sortAsc) {\n          result = -result;\n        }\n\n        if (field === 'locked_at') {\n          result = -result;\n        }\n\n        return result;\n      });\n      this.grid.invalidate();\n      return this.restoreSelection();\n    };\n\n    this.grid.onSort.subscribe(this.sort);\n    this.grid.setSortColumn('runtime', false);\n    return this.sortData = {\n      sortCol: {\n        field: 'locked_at'\n      },\n      sortAsc: false\n    };\n  }\n\n}\n\nclass Tags extends FlavorGrid {\n  constructor(options) {\n    super(options, 'tags', '#tags-grid');\n  }\n\n  build_columns() {\n    return [{\n      id: 'tag',\n      name: i18n_jobs__WEBPACK_IMPORTED_MODULE_0__[\"default\"].t('columns.tag', 'tag'),\n      field: 'tag',\n      width: 200\n    }, {\n      id: 'count',\n      name: i18n_jobs__WEBPACK_IMPORTED_MODULE_0__[\"default\"].t('columns.count', 'count'),\n      field: 'count',\n      width: 50\n    }];\n  }\n\n  grid_options() {\n    return jquery__WEBPACK_IMPORTED_MODULE_1___default.a.extend(super.grid_options(), {\n      enableCellNavigation: false\n    });\n  }\n\n  init() {\n    super.init();\n    this.grid.setSelectionModel(new slickgrid__WEBPACK_IMPORTED_MODULE_2__[\"default\"].RowSelectionModel());\n    return this;\n  }\n\n}\n\njquery__WEBPACK_IMPORTED_MODULE_1___default.a.extend(window, {\n  Jobs,\n  Workers,\n  Tags\n});\njquery__WEBPACK_IMPORTED_MODULE_1___default()(document).ready(() => {\n  jquery__WEBPACK_IMPORTED_MODULE_1___default()('#tags-flavor').change(function () {\n    return window.tags.change_flavor(jquery__WEBPACK_IMPORTED_MODULE_1___default()(this).val());\n  });\n  jquery__WEBPACK_IMPORTED_MODULE_1___default()('#jobs-flavor').change(function () {\n    return window.jobs.change_flavor(jquery__WEBPACK_IMPORTED_MODULE_1___default()(this).val());\n  });\n  jquery__WEBPACK_IMPORTED_MODULE_1___default()('#jobs-refresh').click(() => window.jobs.refresh());\n  const search_event = jquery__WEBPACK_IMPORTED_MODULE_1___default()('#jobs-search')[0].onsearch === void 0 ? 'change' : 'search';\n  jquery__WEBPACK_IMPORTED_MODULE_1___default()('#jobs-search').bind(search_event, function () {\n    return window.jobs.search(jquery__WEBPACK_IMPORTED_MODULE_1___default()(this).val());\n  });\n  jquery__WEBPACK_IMPORTED_MODULE_1___default()('#select-all-jobs').click(() => window.jobs.selectAll());\n  jquery__WEBPACK_IMPORTED_MODULE_1___default()('#hold-jobs').click(() => window.jobs.onSelected('hold'));\n  jquery__WEBPACK_IMPORTED_MODULE_1___default()('#un-hold-jobs').click(() => window.jobs.onSelected('unhold'));\n  jquery__WEBPACK_IMPORTED_MODULE_1___default()('#delete-jobs').click(() => window.jobs.onSelected('destroy'));\n  jquery__WEBPACK_IMPORTED_MODULE_1___default()('#job-handler-show').click(() => {\n    window.jobs.getFullJobDetails(() => jquery__WEBPACK_IMPORTED_MODULE_1___default()('#job-handler-wrapper').clone().dialog({\n      title: i18n_jobs__WEBPACK_IMPORTED_MODULE_0__[\"default\"].t('titles.job_handler', 'Job Handler'),\n      width: 900,\n      height: 700,\n      modal: true\n    }));\n    return false;\n  });\n  jquery__WEBPACK_IMPORTED_MODULE_1___default()('#job-last_error-show').click(() => {\n    window.jobs.getFullJobDetails(() => jquery__WEBPACK_IMPORTED_MODULE_1___default()('#job-last_error-wrapper').clone().dialog({\n      title: i18n_jobs__WEBPACK_IMPORTED_MODULE_0__[\"default\"].t('titles.last_error', 'Last Error'),\n      width: 900,\n      height: 700,\n      modal: true\n    }));\n    return false;\n  });\n});\n/* harmony default export */ __webpack_exports__[\"default\"] = ({\n  Jobs,\n  Workers,\n  Tags\n});\n\nfunction __range__(left, right, inclusive) {\n  const range = [];\n  const ascending = left < right;\n  const end = !inclusive ? right : ascending ? right + 1 : right - 1;\n\n  for (let i = left; ascending ? i < end : i > end; ascending ? i++ : i--) {\n    range.push(i);\n  }\n\n  return range;\n}\n\n//# sourceURL=webpack:///./ui/features/jobs/jquery/index.js?");

/***/ })

}]);