import _objectSpread from "@babel/runtime/helpers/esm/objectSpread2";
import { expect } from 'chai';
import sinon from 'sinon';
import { fromJS } from 'immutable';
import { SET_SEARCH_TEXT, SET_SEARCH_LOADING, SET_SEARCH_ENTRIES } from '../../../constants';
import createMockStore, { scopeActions } from '../../../test/createMockStore';
import * as actions from '../actions';
import { setOutcomes } from '../../../store/context/actions';
var scopedActions = scopeActions(_objectSpread({}, actions, {
  setOutcomes: setOutcomes
}));
describe('search/actions', function () {
  var state = fromJS({
    scopeForTest: {
      config: {
        contextUuid: 'course_100'
      },
      OutcomePicker: {
        search: {
          searchText: 'abc',
          pagination: {
            page: 1,
            total: null
          },
          isLoading: true,
          entries: []
        }
      }
    }
  });
  describe('search updates', function () {
    var clock;
    var service = {
      getSearchResults: sinon.stub().returns(Promise.resolve({}))
    };
    beforeEach(function () {
      clock = sinon.useFakeTimers();
    });
    afterEach(function () {
      clock.restore();
      service.getSearchResults.resetHistory();
    });
    describe('updateSearchText', function () {
      it('handles search flow in the correct order', function () {
        var store = createMockStore(state, service);
        store.dispatch(actions.updateSearchText('def'));
        expect(store.getActions()[0]).to.deep.equal(scopedActions.setSearchText('def'));
        expect(store.getActions()[1]).to.deep.equal(scopedActions.setSearchPage(1));
        expect(store.getActions()[2]).to.deep.equal(scopedActions.setSearchTotal(null));
        expect(store.getActions()[3]).to.deep.equal(scopedActions.setSearchLoading(true));
        expect(store.getActions()).to.have.length(4);
        clock.tick(250);
        expect(store.getActions()).to.have.length(5);
        expect(service.getSearchResults).to.have.been.called;
        expect(service.getSearchResults.getCall(0).args).to.include('def'); // text

        expect(service.getSearchResults.getCall(0).args).to.include(1); // page
      });
    });
    describe('updateSearchPage', function () {
      it('triggers a search action', function () {
        var store = createMockStore(state, service);
        store.dispatch(actions.updateSearchPage(10));
        expect(store.getActions()[0]).to.deep.equal(scopedActions.setSearchLoading(true));
        expect(store.getActions()[1]).to.deep.equal(scopedActions.setSearchPage(10));
        expect(store.getActions()).to.have.length(2);
        clock.tick(250);
        expect(store.getActions()).to.have.length(3);
        expect(service.getSearchResults).to.have.been.called;
        expect(service.getSearchResults.getCall(0).args).to.include('abc'); // text

        expect(service.getSearchResults.getCall(0).args).to.include(10); // page
      });
    });
  });
  describe('setSearchText', function () {
    it('creates an action', function () {
      var action = actions.setSearchText('elephant');
      expect(action.type).to.equal(SET_SEARCH_TEXT);
      expect(action.payload).to.equal('elephant');
    });
  });
  describe('setSearchLoading', function () {
    it('creates an action', function () {
      var action = actions.setSearchLoading(true);
      expect(action.type).to.equal(SET_SEARCH_LOADING);
      expect(action.payload).to.equal(true);
    });
  });
  describe('setSearchEntries', function () {
    it('creates an action', function () {
      var action = actions.setSearchEntries([1, 2, 3]);
      expect(action.type).to.equal(SET_SEARCH_ENTRIES);
      expect(action.payload).to.eql([1, 2, 3]);
    });
  });
  describe('searchOutcomes', function () {
    var matches = [{
      id: '1'
    }];
    var outcomes = {
      course_100: {
        1: {
          id: '1'
        },
        2: {
          id: '2'
        }
      }
    };
    var response = {
      matches: matches,
      outcomes: outcomes['course_100'],
      total: 101
    };
    var service = {
      getSearchResults: function getSearchResults() {
        return new Promise(function (resolve) {
          return resolve(response);
        });
      }
    };
    it('handles search flow in the correct order', function () {
      var store = createMockStore(state, service);
      return store.dispatch(actions.searchOutcomes('abc')).then(function () {
        expect(store.getActions()[1]).to.deep.equal(scopedActions.setOutcomes(outcomes));
        expect(store.getActions()[2]).to.deep.equal(scopedActions.setSearchEntries(matches));
        expect(store.getActions()[3]).to.deep.equal(scopedActions.setSearchTotal(101));
        expect(store.getActions()[4]).to.deep.equal(scopedActions.setSearchLoading(false));
      });
    });
    it('does not set search entries if search query does not match', function () {
      var store = createMockStore(state, service);
      return store.dispatch(actions.searchOutcomes({
        text: 'something else'
      })).then(function () {
        expect(store.getActions().length).to.equal(1);
      });
    });
    it('does not set search entries if search page does not match', function () {
      var store = createMockStore(state, service);
      return store.dispatch(actions.searchOutcomes({
        page: 12
      })).then(function () {
        expect(store.getActions().length).to.equal(1);
      });
    });
  });
});