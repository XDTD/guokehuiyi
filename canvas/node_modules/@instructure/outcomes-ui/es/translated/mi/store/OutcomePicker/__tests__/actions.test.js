import _objectSpread from "@babel/runtime/helpers/esm/objectSpread2";
var _arguments = arguments;

/* eslint-disable promise/always-return */
import { expect } from 'chai';
import { List, Map, fromJS } from 'immutable';
import sinon from 'sinon';
import { SELECT_OUTCOME_IDS, UNSELECT_OUTCOME_IDS, SET_SELECTED_OUTCOME_IDS, SET_OUTCOME_PICKER_STATE, RESET_OUTCOME_PICKER } from '../../../constants';
import createMockStore, { scopeActions } from '../../../test/createMockStore';
import * as actions from '../actions';
import { setError, setScoringMethod } from '../../../store/context/actions';
import { setAlignments } from '../../alignments/actions';
import { setScope } from '../../activePicker/actions';
var scopedActions = scopeActions(_objectSpread({}, actions, {
  setError: setError,
  setScoringMethod: setScoringMethod,
  setAlignments: setAlignments,
  setScope: setScope
}));
describe('OutcomePicker/actions', function () {
  describe('selectOutcomeIds', function () {
    it('creates an action', function () {
      var action = actions.selectOutcomeIds([1, 2, 3]);
      expect(action.type).to.equal(SELECT_OUTCOME_IDS);
      expect(action.payload).to.deep.equal([1, 2, 3]);
    });
  });
  describe('deselectOutcomeIds', function () {
    it('creates an action', function () {
      var action = actions.deselectOutcomeIds([1, 2]);
      expect(action.type).to.equal(UNSELECT_OUTCOME_IDS);
      expect(action.payload).to.deep.equal([1, 2]);
    });
  });
  describe('setSelectedOutcomeIds', function () {
    it('creates an action', function () {
      var action = actions.setSelectedOutcomeIds([1, 2, 3]);
      expect(action.type).to.equal(SET_SELECTED_OUTCOME_IDS);
      expect(action.payload).to.deep.equal([1, 2, 3]);
    });
  });
  describe('setOutcomePickerState', function () {
    it('creates an action', function () {
      var action = actions.setOutcomePickerState('foo');
      expect(action.type).to.equal(SET_OUTCOME_PICKER_STATE);
      expect(action.payload).to.deep.equal('foo');
    });
  });
  describe('loadOutcomePicker', function () {
    it('dispatches state change to loading', function () {
      var store = createMockStore();
      return store.dispatch(actions.loadOutcomePicker()).then(function () {
        expect(store.getActions()[0]).to.deep.equal(scopedActions.setOutcomePickerState('loading'));
      });
    });
    it('dispatches loadOutcomes', function () {
      var service = {
        loadOutcomes: sinon.stub().returns(Promise.resolve({}))
      };
      var store = createMockStore(Map(), service);
      return store.dispatch(actions.loadOutcomePicker()).then(function () {
        expect(service.loadOutcomes.calledOnce).to.be.true;
        expect(service.loadOutcomes.args[0][3]).to.be.null;
      });
    });
    it('dispatches set selected outcome ids', function () {
      var state = fromJS({
        scopeForTest: {
          alignments: {
            alignedOutcomes: [{
              id: '101'
            }, {
              id: '202'
            }]
          }
        }
      });
      var store = createMockStore(state);
      return store.dispatch(actions.loadOutcomePicker()).then(function () {
        expect(store.getActions()).to.deep.include(scopedActions.setSelectedOutcomeIds(['101', '202']));
      });
    });
    it('dispatches state change to choosing', function () {
      var store = createMockStore();
      return store.dispatch(actions.loadOutcomePicker()).then(function () {
        expect(store.getActions()).to.deep.include(scopedActions.setOutcomePickerState('choosing'));
      });
    });
  });
  describe('setActiveCollection', function () {
    it('sets the underlying collection id', function () {
      var store = createMockStore();
      return store.dispatch(actions.setActiveCollection(12)).then(function () {
        expect(store.getActions()).to.deep.include(scopedActions.setActiveCollectionFrd(12));
      });
    });
    it('calls loadMoreOutcomes', function () {
      var service = {
        loadOutcomes: sinon.stub().returns(Promise.resolve({}))
      };
      var store = createMockStore(Map(), service);
      return store.dispatch(actions.setActiveCollection(12)).then(function () {
        expect(service.loadOutcomes.calledOnce).to.be.true;
        expect(service.loadOutcomes.args[0][3]).to.deep.equal([12]);
      });
    });
  });
  describe('setFocusedOutcome', function () {
    it('dispatches setFocusedOutcomeAction', function () {
      var service = {
        setFocusedOutcome: sinon.stub().returns(Promise.resolve())
      };
      var store = createMockStore(Map(), service);
      var full = {
        id: 1,
        scoring_method: {}
      };
      return store.dispatch(actions.setFocusedOutcome(full)).then(function () {
        expect(store.getActions()).to.have.length(1);
        expect(store.getActions()[0]).to.deep.equal(scopedActions.setFocusedOutcomeAction(full));
        return null;
      });
    });
    it('fetches an outcome and dispatches setFocusedOutcomeAction twice', function () {
      var full = {
        id: 1,
        scoring_method: {}
      };
      var service = {
        getOutcome: sinon.stub().returns(Promise.resolve(full)),
        setFocusedOutcome: sinon.stub().returns(Promise.resolve())
      };
      var store = createMockStore(Map(), service);
      var partial = {
        id: 1
      };
      return store.dispatch(actions.setFocusedOutcome(partial)).then(function () {
        expect(store.getActions()).to.have.length(4);
        expect(store.getActions()[0]).to.deep.equal(scopedActions.setFocusedOutcomeAction(partial));
        expect(store.getActions()[2]).to.deep.equal(scopedActions.setScoringMethod({
          context_uuid: void 0,
          id: 1,
          scoring_method: {}
        }));
        expect(store.getActions()[3]).to.deep.equal(scopedActions.setFocusedOutcomeAction(full));
        return null;
      });
    });
  });
  describe('saveOutcomePickerAlignments', function () {
    var state = fromJS({
      context: {
        outcomes: {
          course_100: {
            1: {
              id: '1'
            },
            2: {
              id: '2'
            }
          }
        }
      },
      scopeForTest: {
        config: {
          contextUuid: 'course_100'
        },
        OutcomePicker: {
          selected: ['1', '2'],
          scope: 'scopeForTest'
        }
      }
    });
    it('wraps its calls in setOutcomePickerState', function () {
      var store = createMockStore(state);
      return store.dispatch(actions.saveOutcomePickerAlignments()).then(function () {
        expect(store.getActions()[0]).to.deep.equal(scopedActions.setOutcomePickerState('saving'));
        expect(store.getActions()).to.deep.include(scopedActions.setAlignments({
          guid: 'newguid',
          outcomes: [{
            id: '1'
          }, {
            id: '2'
          }]
        }));
        expect(store.getActions()[store.getActions().length - 1]).to.deep.equal(scopedActions.setOutcomePickerState('complete'));
      });
    });
    it('fires an updateCallback function if provided', function () {
      var store = createMockStore(state);
      var callback = sinon.stub().returns(_arguments);
      return store.dispatch(actions.saveOutcomePickerAlignments(callback)).then(function () {
        expect(callback.calledOnce).to.be.true;
        expect(callback.calledWith({
          guid: 'newguid',
          outcomes: [{
            id: '1'
          }, {
            id: '2'
          }]
        })).to.be.true;
      });
    });
    it('creates alignment set from selection', function () {
      var newState = state.setIn(['OutcomePicker', 'selected'], List(['1', '2', '3']));
      var service = {
        createAlignmentSet: sinon.stub().returns(Promise.resolve())
      };
      var store = createMockStore(newState, service);
      return store.dispatch(actions.saveOutcomePickerAlignments()).then(function () {
        expect(service.createAlignmentSet.calledOnce).to.be.true;
        expect(service.createAlignmentSet.calledWith(['1', '2', '3']));
      });
    });
    it('can pull aligned outcomes from previously aligned outcomes', function () {
      var newState = state.deleteIn(['context', 'outcomes', 'course_100', '1']).setIn(['alignments', 'alignedOutcomes'], fromJS([{
        id: '1'
      }]));
      var service = {
        createAlignmentSet: sinon.stub().returns(Promise.resolve())
      };
      var store = createMockStore(newState, service);
      return store.dispatch(actions.saveOutcomePickerAlignments()).then(function () {
        expect(service.createAlignmentSet.calledWith(['1', '2']));
      });
    });
    it('dispatches setError on save alignments failure', function () {
      var error = {
        message: 'foo bar baz'
      };
      var service = {
        createAlignmentSet: sinon.stub().returns(Promise.reject(error))
      };
      var store = createMockStore(Map(), service);
      return store.dispatch(actions.saveOutcomePickerAlignments()).then(function () {
        expect(store.getActions()).to.have.length(3);
        expect(store.getActions()[2]).to.deep.equal(scopedActions.setError(error));
        return null;
      });
    });
    it('calls upsertArtifact if shouldUpdateArtifact is true', function () {
      var service = {
        upsertArtifact: sinon.stub().returns(Promise.resolve({
          guid: 'guid-1',
          outcomes: ['1', '2']
        }))
      };
      var store = createMockStore(state, service);
      return store.dispatch(actions.saveOutcomePickerAlignments(null, true)).then(function () {
        expect(service.upsertArtifact.calledWith(['1', '2']));
        expect(store.getActions()).to.deep.include(scopedActions.setAlignments({
          guid: 'guid-1',
          outcomes: [{
            id: '1'
          }, {
            id: '2'
          }]
        }));
        expect(store.getActions()[store.getActions().length - 1]).to.deep.equal(scopedActions.setOutcomePickerState('complete'));
      });
    });
  });
  describe('resetOutcomePicker', function () {
    it('creates an action', function () {
      var action = actions.resetOutcomePicker();
      expect(action.type).to.equal(RESET_OUTCOME_PICKER);
    });
  });
  describe('openOutcomePicker', function () {
    it('dispatches flow in the correct order', function () {
      var store = createMockStore();
      store.dispatch(actions.openOutcomePicker());
      expect(store.getActions()[0]).to.deep.equal(scopedActions.setScope('scopeForTest'));
      expect(store.getActions()[1]).to.deep.equal(scopedActions.setOutcomePickerState('loading'));
      expect(store.getActions()).to.have.length(2);
    });
    it('does not try to open an already open picker', function () {
      var state = fromJS({
        scopeForTest: {
          config: {
            contextUuid: 'course_100'
          },
          OutcomePicker: {
            scope: 'scopeForTest',
            state: 'choosing'
          }
        }
      });
      var store = createMockStore(state);
      store.dispatch(actions.openOutcomePicker());
      expect(store.getActions()).to.have.length(0);
    });
  });
  describe('closeOutcomePicker', function () {
    it('dispatches flow in the correct order', function () {
      var store = createMockStore();
      store.dispatch(actions.closeOutcomePicker());
      expect(store.getActions()[0]).to.deep.equal(scopedActions.setScope(''));
      expect(store.getActions()[1]).to.deep.equal(scopedActions.setOutcomePickerState('closed'));
      expect(store.getActions()).to.have.length(2);
    });
  });
});