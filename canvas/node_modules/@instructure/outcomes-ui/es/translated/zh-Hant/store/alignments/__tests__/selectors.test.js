import { expect } from 'chai';
import { Map, fromJS } from 'immutable';
import { getAlignedOutcomeIds, getAlignedOutcomes, getAlignedOutcome, getAlignedOutcomeCount, getAnyOutcome, makeIsOpen } from '../selectors';
describe('alignments/selectors', function () {
  var state = fromJS({
    scopeForTest: {
      alignments: {
        alignedOutcomes: [{
          id: '101',
          label: 'l1',
          title: 't2'
        }, {
          id: '102',
          label: 'l2',
          title: 't1'
        }, {
          id: '103',
          label: 'l3',
          title: 't3'
        }],
        openAlignmentId: 12
      }
    }
  });
  describe('getAlignedOutcomeIds', function () {
    it('retrieves the correct value', function () {
      expect(getAlignedOutcomeIds(state, 'scopeForTest')).to.deep.equal(['102', '101', '103']);
    });
    it('returns [] when not set', function () {
      var newState = Map();
      expect(getAlignedOutcomeIds(newState, 'scopeForTest')).to.deep.equal([]);
    });
  });
  describe('getAlignedOutcomes', function () {
    it('retrieves the outcomes for each aligned outcome id', function () {
      var outcomes = getAlignedOutcomes(state, 'scopeForTest');
      expect(outcomes).to.have.length(3);
      expect(outcomes).to.deep.equal([{
        id: '102',
        label: 'l2',
        title: 't1'
      }, {
        id: '101',
        label: 'l1',
        title: 't2'
      }, {
        id: '103',
        label: 'l3',
        title: 't3'
      }]);
    });
    it('memoizes alignedOutcomes by scope', function () {
      getAlignedOutcomes.resetRecomputations();
      getAlignedOutcomes.clearCache();
      getAlignedOutcomes(state, 'scopeForTest');
      getAlignedOutcomes(Map(), 'newScope');
      getAlignedOutcomes(state, 'scopeForTest');
      expect(getAlignedOutcomes.recomputations()).to.equal(2);
    });
  });
  describe('getAlignedOutcomeCount', function () {
    it('returns the count when the list of outcomes is defined', function () {
      var count = getAlignedOutcomeCount(state, 'scopeForTest');
      expect(count).to.equal(3);
    });
    it('returns 0 when the list is not defined', function () {
      var count = getAlignedOutcomeCount(state, 'anotherScope');
      expect(count).to.equal(0);
    });
  });
  describe('makeIsOpen', function () {
    it('returns true if alignment id is openAlignmentId', function () {
      expect(makeIsOpen(state, 'scopeForTest')(12)).to.be.true;
    });
    it('returns false if another alignment id is openAlignmentId', function () {
      expect(makeIsOpen(state, 'scopeForTest')(13)).to.be.false;
    });
    it('returns false if no alignment is openAlignmentId', function () {
      var newState = Map();
      expect(makeIsOpen(newState, 'scopeForTest')(12)).to.be.false;
    });
  });
  describe('getAlignedOutcome', function () {
    it('retrieves an aligned outcome by its id', function () {
      var outcome = getAlignedOutcome(state, 'scopeForTest', '101');
      expect(outcome).to.deep.equal({
        id: '101',
        label: 'l1',
        title: 't2'
      });
    });
  });
  describe('getAnyOutcome', function () {
    it('can pull outcomes from aligned outcomes', function () {
      var outcome = getAnyOutcome(state, 'scopeForTest', '101');
      expect(outcome.label).to.equal('l1');
    });
    it('can pull outcomes from context outcomes', function () {
      var state = fromJS({
        scopeForTest: {
          config: {
            contextUuid: 'course_100'
          }
        },
        context: {
          outcomes: {
            course_100: {
              1: {
                id: 1,
                label: 'l1',
                title: 't1',
                child_ids: ['2', '3']
              }
            }
          }
        }
      });
      var outcome = getAnyOutcome(state, 'scopeForTest', '1');
      expect(outcome.label).to.equal('l1');
    });
    it('returns null if neither present', function () {
      var state = Map();
      var outcome = getAnyOutcome(state, 'scopeForTest', '101');
      expect(outcome).to.be.null;
    });
  });
});