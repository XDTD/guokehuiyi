"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _chai = require("chai");

var _sinon = _interopRequireDefault(require("sinon"));

var _immutable = require("immutable");

var _constants = require("../../../constants");

var _createMockStore = _interopRequireWildcard(require("../../../test/createMockStore"));

var actions = _interopRequireWildcard(require("../actions"));

var scopedActions = (0, _createMockStore.scopeActions)(actions);
var response = {
  outcomes: [{
    id: 1
  }, {
    id: 2
  }],
  root_ids: [1, 2]
};
var stateWithoutOutcomes = (0, _immutable.fromJS)({
  scopeForTest: {
    config: {
      contextUuid: 'course_100'
    }
  }
});
var stateWithOutcomes = (0, _immutable.fromJS)({
  context: {
    outcomes: {
      course_100: [{
        id: 1
      }]
    },
    rootOutcomeIds: {
      course_100: [1]
    }
  },
  scopeForTest: {
    config: {
      contextUuid: 'course_100'
    }
  }
});
describe('context/actions', function () {
  describe('setOutcomes', function () {
    it('creates an action', function () {
      var action = actions.setOutcomes([]);
      (0, _chai.expect)(action.type).to.equal(_constants.SET_OUTCOMES);
      (0, _chai.expect)(action.payload).to.deep.equal([]);
    });
  });
  describe('setRootOutcomeIds', function () {
    it('creates an action', function () {
      var action = actions.setRootOutcomeIds([]);
      (0, _chai.expect)(action.type).to.equal(_constants.SET_ROOT_OUTCOME_IDS);
      (0, _chai.expect)(action.payload).to.deep.equal([]);
    });
  });
  describe('setError', function () {
    it('creates an action', function () {
      var action = actions.setError('foo');
      (0, _chai.expect)(action.type).to.equal(_constants.SET_ERROR);
      (0, _chai.expect)(action.payload).to.deep.equal('foo');
    });
  });
  describe('setScoringMethod', function () {
    it('creates an action', function () {
      var payload = {
        id: 1,
        context_uuid: '',
        scoring_method: {}
      };
      var action = actions.setScoringMethod(payload);
      (0, _chai.expect)(action.type).to.equal(_constants.SET_SCORING_METHOD);
      (0, _chai.expect)(action.payload).to.deep.equal(payload);
    });
  });
  describe('loadOutcomes', function () {
    it('does not call any actions when outcomes already loaded', function () {
      var store = (0, _createMockStore.default)(stateWithOutcomes);
      return store.dispatch(actions.loadRootOutcomes()).then(function () {
        (0, _chai.expect)(store.getActions()).to.have.length(0);
        return null;
      });
    });
    it('calls outcome service to load outcomes', function () {
      var service = {
        loadOutcomes: _sinon.default.stub().returns(Promise.resolve(response))
      };
      var store = (0, _createMockStore.default)((0, _immutable.Map)(), service);
      return store.dispatch(actions.loadRootOutcomes()).then(function () {
        (0, _chai.expect)(service.loadOutcomes.calledOnce).to.be.true;
        return null;
      });
    });
    it('dispatches setOutcomes on outcome service success', function () {
      var service = {
        loadOutcomes: _sinon.default.stub().returns(Promise.resolve(response))
      };
      var store = (0, _createMockStore.default)(stateWithoutOutcomes, service);
      return store.dispatch(actions.loadRootOutcomes()).then(function () {
        (0, _chai.expect)(store.getActions()).to.deep.include(scopedActions.setOutcomes({
          course_100: response.outcomes
        }));
        (0, _chai.expect)(store.getActions()[0].payload.root).to.be.present;
        return null;
      });
    });
    it('creates a root level outcome to store roots if root ids are present', function () {
      var service = {
        loadOutcomes: _sinon.default.stub().returns(Promise.resolve(response))
      };
      var store = (0, _createMockStore.default)((0, _immutable.Map)(), service);
      return store.dispatch(actions.loadRootOutcomes()).then(function () {
        (0, _chai.expect)(store.getActions()[0].payload.root).to.be.present;
        return null;
      });
    });
    it('does not create a root level outcome if root ids are not present', function () {
      var service = {
        loadOutcomes: _sinon.default.stub().returns(Promise.resolve({
          outcomes: [{
            id: 1
          }, {
            id: 2
          }],
          root_ids: []
        }))
      };
      var store = (0, _createMockStore.default)((0, _immutable.Map)(), service);
      return store.dispatch(actions.loadRootOutcomes()).then(function () {
        (0, _chai.expect)(store.getActions()[0].payload.root).not.to.be.present;
        return null;
      });
    });
    it('dispatches setRootOutcomeIds on outcome service success', function () {
      var service = {
        loadOutcomes: _sinon.default.stub().returns(Promise.resolve(response))
      };
      var store = (0, _createMockStore.default)(stateWithoutOutcomes, service);
      return store.dispatch(actions.loadRootOutcomes()).then(function () {
        (0, _chai.expect)(store.getActions()).to.deep.include(scopedActions.setRootOutcomeIds({
          course_100: response.root_ids
        }));
        return null;
      });
    });
    it('dispatches setError on outcome service failure', function () {
      var error = {
        message: 'foo bar baz'
      };
      var service = {
        loadOutcomes: _sinon.default.stub().returns(Promise.reject(error))
      };
      var store = (0, _createMockStore.default)((0, _immutable.Map)(), service);
      return store.dispatch(actions.loadRootOutcomes()).then(function () {
        (0, _chai.expect)(store.getActions()).to.have.length(2);
        (0, _chai.expect)(store.getActions()[1]).to.deep.equal(scopedActions.setError(error));
        return null;
      });
    });
  });
  describe('loadMoreOutcomes', function () {
    it('calls loadOutcomes for unloaded children', function () {
      var service = {
        loadOutcomes: _sinon.default.stub().returns(Promise.resolve(response))
      };
      var store = (0, _createMockStore.default)(stateWithOutcomes, service);
      return store.dispatch(actions.loadMoreOutcomes('1')).then(function () {
        (0, _chai.expect)(service.loadOutcomes.calledOnce).to.be.true;
        (0, _chai.expect)(service.loadOutcomes.args[0][3]).to.deep.equal(['1']);
        return null;
      });
    });
    it('adds its outcomes to the state', function () {
      var service = {
        loadOutcomes: _sinon.default.stub().returns(Promise.resolve(response))
      };
      var store = (0, _createMockStore.default)(stateWithOutcomes, service);
      return store.dispatch(actions.loadMoreOutcomes('1')).then(function () {
        (0, _chai.expect)(store.getActions()).to.deep.include(scopedActions.setOutcomes({
          course_100: response.outcomes
        }));
        return null;
      });
    });
    it('does not add its root ids to the state', function () {
      var service = {
        loadOutcomes: _sinon.default.stub().returns(Promise.resolve(response))
      };
      var store = (0, _createMockStore.default)(stateWithoutOutcomes, service);
      return store.dispatch(actions.loadMoreOutcomes('1')).then(function () {
        (0, _chai.expect)(store.getActions()).not.to.deep.include(scopedActions.setRootOutcomeIds({
          course_100: response.root_ids
        }));
        return null;
      });
    });
    it('dispatches setError on outcome service failure', function () {
      var error = {
        message: 'foo bar baz'
      };
      var service = {
        loadOutcomes: _sinon.default.stub().returns(Promise.reject(error))
      };
      var store = (0, _createMockStore.default)((0, _immutable.Map)(), service);
      return store.dispatch(actions.loadMoreOutcomes('12')).then(function () {
        (0, _chai.expect)(store.getActions()).to.have.length(2);
        (0, _chai.expect)(store.getActions()[1]).to.deep.equal(scopedActions.setError(error));
        return null;
      });
    });
  });
  describe('loadContext', function () {
    var response = {
      id: 1
    };
    var stateWithoutContext = (0, _immutable.fromJS)({
      context: {
        contexts: {}
      }
    });
    var stateWithContext = (0, _immutable.fromJS)({
      context: {
        contexts: {
          '1': {
            loading: false,
            data: {
              id: 1
            }
          }
        }
      }
    });
    var stateWithContextLoading = (0, _immutable.fromJS)({
      context: {
        contexts: {
          '1': {
            loading: true
          }
        }
      }
    });
    it('calls getContext for unloaded children', function () {
      var service = {
        getContext: _sinon.default.stub().returns(Promise.resolve(response))
      };
      var store = (0, _createMockStore.default)(stateWithoutContext, service);
      return store.dispatch(actions.loadContext('host', 'jwt', '1')).then(function () {
        (0, _chai.expect)(service.getContext.calledOnce).to.be.true;
        (0, _chai.expect)(service.getContext.args[0][2]).to.equal('1');
        return null;
      });
    });
    it('adds its context to the state', function () {
      var service = {
        getContext: _sinon.default.stub().returns(Promise.resolve(response))
      };
      var store = (0, _createMockStore.default)(stateWithoutContext, service);
      return store.dispatch(actions.loadContext('host', 'jwt', '1')).then(function () {
        (0, _chai.expect)(store.getActions()).to.deep.include(scopedActions.setContext({
          '1': {
            loading: false,
            data: response
          }
        }));
        return null;
      });
    });
    it('does not calls service when its already loaded', function () {
      var service = {
        getContext: _sinon.default.stub().returns(Promise.resolve(response))
      };
      var store = (0, _createMockStore.default)(stateWithContext, service);
      return store.dispatch(actions.loadContext('host', 'jwt', '1')).then(function () {
        (0, _chai.expect)(store.getActions().length).to.be.equal(0);
        return null;
      });
    });
    it('does not calls service when its loading', function () {
      var service = {
        getContext: _sinon.default.stub().returns(Promise.resolve(response))
      };
      var store = (0, _createMockStore.default)(stateWithContextLoading, service);
      return store.dispatch(actions.loadContext('host', 'jwt', '1')).then(function () {
        (0, _chai.expect)(store.getActions().length).to.be.equal(0);
        return null;
      });
    });
    it('dispatches setError on service failure', function () {
      var error = {
        message: 'foo bar baz'
      };
      var service = {
        getContext: _sinon.default.stub().returns(Promise.reject(error))
      };
      var store = (0, _createMockStore.default)((0, _immutable.Map)(), service);
      return store.dispatch(actions.loadContext('host', 'jwt', '12')).then(function () {
        (0, _chai.expect)(store.getActions()).to.have.length(3);
        (0, _chai.expect)(store.getActions()[2]).to.deep.equal(scopedActions.setError(error));
        return null;
      });
    });
  });
});