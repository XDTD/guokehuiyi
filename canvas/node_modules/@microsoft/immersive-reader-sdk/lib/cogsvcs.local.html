<!DOCTYPE html>
<html>
<head>
    <script type='text/javascript' src='https://code.jquery.com/jquery-3.3.1.min.js'></script>
    <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-min.js'></script>
    <script type='text/javascript' src='immersive-reader-sdk.edog.js'></script>

    <style>
        body {
            font-family: 'Segoe UI'
        }
        .table thead th {
            font-weight: 600;
        }
        .regionheader {
            padding-bottom: 3px;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <h2>Immersive Reader SDK - Tests</h2>
    <div style='padding: 5px'>
        <div>Title</div>
        <input id='input-title' type='text' style='width: 400px' value='Immersive Reader' />

        <div>Text</div>
        <textarea id='input-text' style='height: 200px; width: 100%; font-family: "Segoe UI"'>
The study of Earthâ€™s landforms is called physical geography. Landforms can be mountains and valleys. They can also be glaciers, lakes or rivers. Landforms are sometimes called physical features. It is important for students to know about the physical geography of Earth. The seasons, the atmosphere and all the natural processes of Earth affect where people are able to live. Geography is one of a combination of factors that people use to decide where they want to live.
The physical features of a region are often rich in resources. Within a nation, mountain ranges become natural borders for settlement areas. In the U.S., major mountain ranges are the Sierra Nevada, the Rocky Mountains, and the Appalachians.
Fresh water sources also influence where people settle. People need water to drink. They also need it for washing. Throughout history, people have settled near fresh water. Living near a water source helps ensure that people have the water they need. There was an added bonus, too. Water could be used as a travel route for people and goods. Many Americans live near popular water sources, such as the Mississippi River, the Colorado River and the Great Lakes.
Mountains and deserts have been settled by fewer people than the plains areas. However, they have valuable resources of their own.
        </textarea>

        <div>Lang</div>
        <input id='input-lang' type='text' value='en' />

        <div>MIME Type</div>
        <input id='input-mimetype' type='text' value='text/plain' />

        <div>Raw JSON</div>
        <textarea id='input-json' style='height: 100px; width: 100%; font-family: "Segoe UI"'></textarea>
    </div>

    <br>
    <div>
        <input type="radio" name="readerDomainRadio" value="local" /> Local Reader
        <input type="radio" name="readerDomainRadio" value="deployed" checked/> Deployed Reader
    </div>

    <br>
    <div style='padding-bottom: 5px;'>Resource Region (Prod)</div>
    <div style='width: 450px; display: table; table-layout: fixed;'>
        <div style='display: table-row'>
            <div style='display: table-cell'>
                <div class='regionheader'>NAM</div>
                <input type="radio" name="prodRegion" value="EastUS" /> EastUS <br>
                <input type="radio" name="prodRegion" value="EastUS2" /> EastUS2 <br>
                <input type="radio" name="prodRegion" value="SouthCentralUS" /> SouthCentralUS <br>
                <input type="radio" name="prodRegion" value="WestUS" checked /> WestUS <br>
                <input type="radio" name="prodRegion" value="WestUS2" /> WestUS2 <br>
            </div>
            <div style='display: table-cell'>
                <div class='regionheader'>EUR</div>
                <input type="radio" name="prodRegion" value="NorthEurope" /> NorthEurope <br>
                <input type="radio" name="prodRegion" value="WestEurope" /> WestEurope <br>
                <input type="radio" name="prodRegion" value="UKSouth" /> UKSouth <br>
            </div>
            <div style='display: table-cell'>
                <div class='regionheader'>APC</div>
                <input type="radio" name="prodRegion" value="AustraliaEast" /> AustraliaEast <br>
                <input type="radio" name="prodRegion" value="CentralIndia" /> CentralIndia <br>
                <input type="radio" name="prodRegion" value="JapanEast" /> JapanEast <br>
                <input type="radio" name="prodRegion" value="SouthEastAsia" /> SouthEastAsia <br>
            </div>
        </div>
    </div>

    <br>
    <div style='padding-bottom: 5px;'>Product SKU</div>
    <input type="radio" name="productSKU" value="S0" checked /> S0 <br>
    <input type="radio" name="productSKU" value="S1" /> S1 <br>

    <br>
    <div style='padding-bottom: 5px; font-weight: 500'>Options</div>
    <div>
        <input type="checkbox" name="optionsCheckbox" value="allowFullscreen" id="allowFullscreenOptionCheckbox" checked="checked"/>
        <label for="allowFullscreenOptionCheckbox">allowFullscreen</label>
        <input type="checkbox" name="optionsCheckbox" value="hideExitButton" id="hideExitButtonOptionCheckbox" />
        <label for="hideExitButtonOptionCheckbox">hideExitButton</label>
        <input type="checkbox" name="optionsCheckbox" value="onExit" id="onExitOptionCheckbox" />
        <label for="onExitOptionCheckbox">onExit</label>
        <input type="checkbox" name="optionsCheckbox" value="disableFirstRun" id="disableFirstRunCheckbox" />
        <label for="disableFirstRunCheckbox">disableFirstRun</label>
        <input type="checkbox" value="persistPreferences" id="persistPreferencesCheckbox" />
        <label for="persistPreferencesCheckbox">Persist Preferences</label>
    </div>
    <div>
        <label for="uiLangOption">uiLangOption (string)</label>
        <input type="text" id="uiLangOption" class="optionTextBox" data-option-name="uiLang" placeholder="en-us" />
        <label for="timeoutOption" style="margin-left: 10px;">timeout (number)</label>
        <input type="number" id="timeoutOption" class="optionTextBox" data-option-name="timeout" placeholder="15000" />
        <label for="uiZIndexOption" style="margin-left: 10px;">uiZIndex (number)</label>
        <input type="number" id="uiZIndexOption" class="optionTextBox" data-option-name="uiZIndex" placeholder="1000" />
        <label for="cookiePolicyOption" style="margin-left: 10px;">cookiePolicy (0 for disable, 1 for enable)</label>
        <input type="number" id="cookiePolicyOption" class="optionTextBox" data-option-name="cookiePolicy" placeholder="0" />
    </div>
    <br />
    <div style='padding-bottom: 5px; font-weight: 500'>Read Aloud Options</div>
    <div>
        <input type="checkbox" id="readAloudAutoplay" />
        <label for="readAloudAutoplay">Autoplay</label>
    </div>
    <div>
        <label for="readAloudGender">Gender</label>
        <input type="text" id="readAloudGender" />
        <label for="readAloudSpeed">Speed</label>
        <input type="number" id="readAloudSpeed" />
    </div>

    <br>
    <table cellpadding='5px' class='table'>
        <thead>
            <tr>
                <th>Version</th>
                <th>Edog</th>
                <th>Prod</th>
            </tr>
        </thead>
        <tbody data-bind='foreach: versions'>
            <tr>
                <td data-bind='text: $data'></td>
                <td>
                    <button data-bind='click: launch.bind(null, $data, "edog")'>Launch</button>
                </td>
                <td>
                    <button data-bind='click: launch.bind(null, $data, "prod")'>Launch</button>
                </td>
            </tr>
        </tbody>
    </table>

    <script type='text/javascript'>

        function launch (version, environment) {
            getTokenAndLaunch(version, environment);
        };


        function getTokenAndLaunch(version, environment) {

            var authInfo = getAuthInfo(version, environment);

            $.ajax(authInfo.url, {
                method: 'GET',
                success: function(token) {
                    launchInternal(version, authInfo.subdomain, token);
                },
                error : function (xhr, status, error) {
                    console.log("GetToken error: " + status + " - " + error);
                }
            });
        }

        const subdomains =
        {
            edog: {
                S0: {
                    WestUS: 'immersivereaderaad',
                },
                S1: {
                    WestUS: 'immersivereaderS1aadwestus'
                }
            },
            prod: {
                S0: {
                    EastUS: 'immersivereaderaadeastus',
                    EastUS2: 'immersivereaderaadeastus2',
                    SouthCentralUS: 'immersivereaderaadsouthcentralus',
                    WestUS: 'immersivereaderaad',
                    WestUS2: 'immersivereaderaadwestus2',
                    NorthEurope: 'immersivereaderaadnortheurope',
                    WestEurope: 'immersivereaderaadwesteurope',
                    UKSouth: 'immersivereaderaaduksouth',
                    AustraliaEast: 'immersivereaderaadaustraliaeast',
                    CentralIndia: 'immersivereaderaadcentralindia',
                    JapanEast: 'immersivereaderaadjapaneast',
                    SouthEastAsia: 'immersivereaderaadsoutheastasia',
                },
                S1: {
                    EastUS: 'immersivereaderS1aadeastus',
                    EastUS2: 'immersivereaderS1aadeastus2',
                    SouthCentralUS: 'immersivereaderS1aadsouthcentralus',
                    WestUS: 'immersivereaderS1aadwestus',
                    WestUS2: 'immersivereaderS1aadwestus2',
                    NorthEurope: 'immersivereaderS1aadnortheurope',
                    WestEurope: 'immersivereaderS1aadwesteurope',
                    UKSouth: 'immersivereaderS1aaduksouth',
                    AustraliaEast: 'immersivereaderS1aadaustraliaeast',
                    CentralIndia: 'immersivereaderS1aadcentralindia',
                    JapanEast: 'immersivereaderS1aadjapaneast',
                    SouthEastAsia: 'immersivereaderS1aadsoutheastasia',
                }
            }
        };
        var _preferences = '';

        function getAuthInfo(version, environment) {

            const issueTokenUrl = 'https://learningtools.edog.onenote.com/learningtoolsapi/cognitive/v2.0/getcogsvcsaccesstoken';
            const aadTokenUrl = 'https://learningtools.edog.onenote.com/learningtoolsapi/cognitive/v2.0/getcogsvcsaadtoken';

            const environmentTokenEndpoint = {
                edog: {
                    issueTokenUrl: issueTokenUrl,
                    aadTokenUrl: aadTokenUrl,
                },
                prod: {
                    issueTokenUrl: issueTokenUrl + '?prodEnvironment=true',
                    aadTokenUrl: aadTokenUrl + '?prodEnvironment=true',
                }
            };

            var url = version === '0.0.1' ? environmentTokenEndpoint[environment].issueTokenUrl : environmentTokenEndpoint[environment].aadTokenUrl;

            var region = environment === 'prod' ? $('input[name=prodRegion]:checked').val() : 'WestUS';
            var sku = $('input[name=productSKU]:checked').val()
            var subdomain = version === '0.0.1' ? null : subdomains[environment][sku][region];

            return {url: url, subdomain: subdomain};
        }

        function getOptions() {
            var options = {
                //displayOptions: {textSize: 87, fontFamily: 'ComicSans', increaseSpacing: false}
            }

            var optionsCheckboxes = document.getElementsByName("optionsCheckbox");
            for (var i = 0; i < optionsCheckboxes.length; i++) {
                var checkbox = optionsCheckboxes.item(i);
                if (checkbox.checked) {
                    options[checkbox.value] = true;
                } else {
                    options[checkbox.value] = false;
                }
            }

            var optionsTextBoxes = document.getElementsByClassName("optionTextBox");
            for (var i = 0; i < optionsTextBoxes.length; i++) {
                var textbox = optionsTextBoxes.item(i);
                var optionName = textbox.getAttribute("data-option-name");
                if (textbox.value && optionName) {
                    options[optionName] = textbox.type === "number" ? textbox.valueAsNumber : textbox.value;
                }
            }

            var persistPreferences = document.getElementById("persistPreferencesCheckbox").checked;
            if (persistPreferences) {
                options.onPreferencesChanged = (value) => {
                    _preferences = value;
                }
                options.preferences = _preferences;
            }

            return options;
        }

        function launchInternal(version, subdomain, token) {
            var chunks = [ {
                content: $('#input-text').val(),
                lang: $('#input-lang').val(),
                mimeType: $('#input-mimetype').val()
            } ];

            const rawJson = $('#input-json').val();
            if (rawJson) {
                chunks = JSON.parse(rawJson);
            }

            const content = {
                title: $('#input-title').val(),
                chunks: chunks
            };

            const readerDomainOption = $('input[name=readerDomainRadio]:checked').val();
            console.log('using reader domain ' + readerDomainOption);

            let options = getOptions();

            if (readerDomainOption === 'local') {
                options.customDomain = "https://localhost:44444/";
            }

            if (options.onExit === true)
            {
                options.onExit = () => { $('#input-text').val('On Exit Executed successfully.'); };
            }

            options.readAloudOptions = {
                autoplay: $('#readAloudAutoplay').prop('checked'),
                voice: $('#readAloudGender').val(),
                speed: +($('#readAloudSpeed').val())
            };

            if (version === '0.0.1') {
                ImmersiveReader.launchAsync(token, content, options)
                    .then(() => {
                        handleSuccess();
                    })
                    .catch ((error) => {
                        handleError(error);
                    });
            } else {
                ImmersiveReader.launchAsync(token, subdomain, content, options)
                    .then((response) => {
                        handleSuccess();
                        console.log('Processed: ' + response.charactersProcessed);
                    })
                    .catch ((error) => {
                        handleError(error);
                    });
            }
        }

        function handleSuccess() {
            console.log('Successful launch.');
        }

        function handleError(error) {
            console.log('There was an error', error);
        }

        // Initialize Knockout viewmodel with available versions of the SDK
        const vm = {
            versions: ko.observableArray([ 'dev', 'preview', '1.0.0', '0.0.3', '0.0.2', '0.0.1' ])
        };
        ko.applyBindings(vm);
    </script>
</body>
</html>